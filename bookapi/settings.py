"""
Django settings for bookapi project.

Generated by 'django-admin startproject' using Django 5.2.8.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path
from datetime import timedelta
import os

from drf_spectacular.settings import SPECTACULAR_DEFAULTS, spectacular_settings

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-$gh8bvd*)$-(em3)j-4k@c@gofv5o$kremi-b1-&x@f%gprb!o'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition
#`INSTALLED_APPS` å°±åƒâ€œå¯ç”¨æ’ä»¶â€ï¼Œåªæœ‰åœ¨è¿™é‡Œç™»è®°è¿‡çš„ Appï¼ŒDjango æ‰ä¼šåŠ è½½å®ƒçš„ä»£ç ã€‚
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework', #é…ç½® Django å¯ç”¨ DRF
    'rest_framework_simplejwt', #é…ç½® Django å¯ç”¨ JWT
    'django_filters', #é…ç½® Django å¯ç”¨ django_filters
    'books', # é…ç½®è‡ªå®šä¹‰çš„app
    'drf_spectacular', # é…ç½® drf_spectacularï¼Œå¯ä»¥ä½¿ç”¨OpenAPI 3.0

]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'bookapi.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates']
        ,
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'bookapi.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


REST_FRAMEWORK = {
    # DRFè®¾ç½®å…¨å±€åˆ†é¡µï¼Œæ‰€æœ‰ ViewSet è‡ªåŠ¨ç”Ÿæ•ˆã€‚
    # è¿™æ ·è®¾ç½®åï¼Œ**æ‰€æœ‰ç»§æ‰¿ `ListModelMixin` çš„è§†å›¾**ï¼ˆå¦‚ `ModelViewSet`ï¼‰éƒ½ä¼šè‡ªåŠ¨åˆ†é¡µï¼
    # Web ç½‘ç«™ï¼ˆé¡µç å¯¼èˆªï¼‰è®¾ç½®åˆ†é¡µ
    # http://127.0.0.1:8000/api/books/
    'DEFAULT_PAGINATION_CLASS': "rest_framework.pagination.PageNumberPagination", #æŒ‡å®šé»˜è®¤åˆ†é¡µç±»
    # ç§»åŠ¨ç«¯ Appï¼ˆæ»‘åŠ¨åŠ è½½ï¼‰è®¾ç½®åˆ†é¡µ
    # http://127.0.0.1:8000/api/books/?limit=5&offset=10
    # | `limit=5`   | æœ€å¤šè¿”å›5æ¡                |
    # | `offset=10` | è·³è¿‡å‰10æ¡ï¼ˆä»ç¬¬11æ¡å¼€å§‹ï¼‰ |
    # 'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.LimitOffsetPagination',
    'PAGE_SIZE': 5, # æ¯é¡µè¿”å›å¤šå°‘æ¡æ•°æ®

    # é…ç½®é»˜è®¤è¿‡æ»¤åç«¯
    'DEFAULT_FILTER_BACKENDS': [
        'django_filters.rest_framework.DjangoFilterBackend',  #å­—æ®µç²¾ç¡®è¿‡æ»¤ï¼ˆå¦‚ `?author=å¼ ä¸‰`ï¼‰
        'rest_framework.filters.SearchFilter',              #å…¨æ–‡æœç´¢ï¼ˆå¦‚ `?search=Python`ï¼‰
        'rest_framework.filters.OrderingFilter',            #æ’åºï¼ˆå¦‚ `?ordering=price`ï¼‰

    ],
    #
    # === å…¨å±€é…ç½®è®¤è¯åç«¯ ===
    # æ³¨æ„ï¼š`DEFAULT_AUTHENTICATION_CLASSES` æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯ä»¥åŒæ—¶æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼DRF ä¼šæŒ‰é¡ºåºå°è¯•æ¯ç§è®¤è¯æ–¹å¼ï¼Œç›´åˆ°æˆåŠŸ
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication', #`å¯ç”¨åŸºäº Session çš„è®¤è¯ï¼ˆæµè§ˆå™¨ç™»å½•åè‡ªåŠ¨æºå¸¦ Cookieï¼‰
        'rest_framework_simplejwt.authentication.JWTAuthentication', # è‡ªåŠ¨è§£æè¯·æ±‚å¤´ä¸­çš„ `Authorization: Bearer <access_token>`
    ],
    # === å…¨å±€é…ç½®é»˜è®¤æƒé™ ===
    #  æ³¨æ„ï¼šè¿™æ˜¯**å…¨å±€è®¾ç½®**ï¼Œé™¤éæŸä¸ªè§†å›¾æ˜¾å¼è¦†ç›–ï¼Œå¦åˆ™æ‰€æœ‰æ¥å£éƒ½å¿…é¡»ç™»å½•ï¼
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated', # é»˜è®¤æ‰€æœ‰æ¥å£éƒ½éœ€è¦ç™»å½•
    ],
    # === æ–°å¢ï¼šå…¨å±€é»˜è®¤é™æµ ===
    # `'DEFAULT_THROTTLE_CLASSES'`è®¾ç½®å…¨å±€ä½¿ç”¨çš„é™æµç±» åªæœ‰è¢«åˆ—å‡ºçš„é™æµç±»æ‰ä¼šç”Ÿæ•ˆ
    'DEFAULT_THROTTLE_CLASSES': [
        # `'AnonRateThrottle'`åŒ¿åç”¨æˆ·é™æµç±» å¯¹æœªç™»å½•ç”¨æˆ·ç”Ÿæ•ˆâš ï¸ éœ€é…åˆ `DEFAULT_THROTTLE_RATES`
        # 'rest_framework.throttling.AnonRateThrottle', # åŒ¿åç”¨æˆ·é™æµ

        # `'UserRateThrottle'`ç™»å½•ç”¨æˆ·é™æµç±» å¯¹å·²ç™»å½•ç”¨æˆ·ç”Ÿæ•ˆâœ… å¸¸ç”¨äºæ™®é€šç”¨æˆ·
        # 'rest_framework.throttling.UserRateThrottle', # ç™»å½•ç”¨æˆ·é™æµ

        # å¦‚æœä½¿ç”¨å®˜æ–¹åŸç”Ÿçš„é™æµç±»ï¼ŒåŒ¿åé™æµè§„åˆ™èƒ½æˆåŠŸï¼Œä½¿ç”¨è‡ªå®šä¹‰é™æµè§„åˆ™ä¹‹åï¼ŒåŒ¿åç”¨æˆ·é™æµè§„åˆ™å°±å¤±æ•ˆäº†
        'books.throttling.AdminUserThrottle', # ä½¿ç”¨è‡ªå®šä¹‰é™æµç±»

    ],
    # `'DEFAULT_THROTTLE_RATES'`å®šä¹‰é€Ÿç‡è§„åˆ™ æŒ‡å®šæ¯ä¸ªé™æµç±»çš„å…·ä½“é€Ÿåº¦âœ… å¿…é¡»å’Œä¸Šé¢å¯¹åº”
    'DEFAULT_THROTTLE_RATES': {
        # `'anon': '5/hour'`åŒ¿åç”¨æˆ·æ¯å°æ—¶5æ¬¡ æ ¼å¼ï¼šæ•°å­— + / + æ—¶é—´å•ä½âœ… å•ä½ï¼šsecond, minute, hour, day
        'anon': '5/hour',   # åŒ¿åç”¨æˆ·æ¯å°æ—¶5æ¬¡
        # `'user': '10/minute'`ç™»å½•ç”¨æˆ·æ¯åˆ†é’Ÿ10æ¬¡ æ›´å®½æ¾ï¼Œé€‚åˆæ­£å¸¸ç”¨æˆ·âœ… æ”¯æŒå°æ•°ï¼Œå¦‚ `3.5/minute`
        'user': '10/minute',# ç™»å½•ç”¨æˆ·æ¯åˆ†é’Ÿ10æ¬¡
        # ç®¡ç†å‘˜å¯ä»¥é«˜é€Ÿè®¿é—®
        # 'admin': '1000/minute', #ç®¡ç†å‘˜æ¯åˆ†é’Ÿ1000æ¬¡
    },

    # æ³¨å†Œè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨ï¼š`'EXCEPTION_HANDLER'`ï¼šå‘Šè¯‰ DRF ä½¿ç”¨æˆ‘ä»¬å†™çš„å‡½æ•°å¤„ç†æ‰€æœ‰å¼‚å¸¸
    'EXCEPTION_HANDLER': 'bookapi.exceptions.custom_exception_handler',
    # ç¡®ä¿ drf-spectacular æ˜¯å”¯ä¸€çš„ schema æä¾›è€…
    # è¿™ä¸€è¡Œå‘Šè¯‰ DRFï¼šâ€œè¯·ç”¨ drf-spectacular æä¾›çš„ AutoSchema æ¥ç”Ÿæˆ API æ–‡æ¡£â€ã€‚
    # å¦‚æœä¸å†™è¿™è¡Œï¼ŒDRF å¯èƒ½ä¼šç»§ç»­ä½¿ç”¨è‡ªå·±çš„ schema ç±»ï¼Œå¯¼è‡´å†²çªã€‚
    # å³ä½¿ä½ å·²ç»å®‰è£…äº† drf-spectacularï¼Œä¹Ÿå¿…é¡»æ˜¾å¼è®¾ç½®è¿™ä¸ªå€¼ï¼
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema', # â† å¿…é¡»æ˜¾å¼æŒ‡å®šï¼


}

# é…ç½®JWT
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=15), # access token æœ‰æ•ˆæœŸ
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1), # refresh token æœ‰æ•ˆæœŸ
    'ROTATE_REFRESH_TOKENS': False,         # åˆ·æ–°æ—¶æ˜¯å¦æ¢æ–° refresh token
    'BLACKLIST_AFTER_ROTATION':False,       # æ˜¯å¦æ‹‰é»‘æ—§ refresh token
}

# é…ç½®åª’ä½“æ–‡ä»¶ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰è·¯å¾„
# | é…ç½®é¡¹       | ä½œç”¨                               | ç¤ºä¾‹                                |
# | ------------ | ---------------------------------- | ----------------------------------- |
# | `MEDIA_URL`  | å‰ç«¯è®¿é—®ä¸Šä¼ æ–‡ä»¶çš„**URLå‰ç¼€**      | `/media/`                           |
# | `MEDIA_ROOT` | æœåŠ¡å™¨ä¸Šå®é™…å­˜æ”¾æ–‡ä»¶çš„**æœ¬åœ°è·¯å¾„** | `E:\Projects\pycharm\bookapi\media` |
# ğŸ’¡ ä¾‹å¦‚ï¼š
# - ä¸Šä¼ æ–‡ä»¶ â†’ å­˜åˆ° `media/covers/1/cover.jpg`
# - å‰ç«¯è®¿é—® â†’ `http://127.0.0.1:8000/media/covers/1/cover.jpg`
MEDIA_URL = '/media/'  # å‰ç«¯è®¿é—®æ—¶ç”¨çš„URLè·¯å¾„
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')  # å®é™…æ–‡ä»¶å­˜å‚¨è·¯å¾„

# dsf-spectacular é…ç½®
SPECTACULAR_SETTINGS = {
    'TITLE': 'å›¾ä¹¦ç®¡ç†ç³»ç»ŸAPI',
    'DESCRIPTION': 'è¿™æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å›¾ä¹¦ä¿¡æ¯çš„RESTful API.',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,  # æ˜¯å¦åœ¨æ–‡æ¡£é¡µé¢æ˜¾ç¤ºschema
    'COMPONENT_SPLIT_REQUEST': True,  # å°†è¯·æ±‚å’Œå“åº”å‚æ•°åˆ†å¼€å®šä¹‰ï¼ˆæ›´æ¸…æ™°ï¼‰
}

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
# 1. è®¾ç½® DEBUG = False ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»å…³é—­ï¼‰
# DEBUG = False
# 2. å…è®¸çš„ä¸»æœºåŸŸåï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®ï¼‰
# ALLOWED_HOSTS = ['your-domain.com', 'www.your-domain.com', '127.0.0.1'] # æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåip
# 3.æ•°æ®åº“é…ç½®ï¼ˆå»ºè®®ä½¿PostgreSQL æˆ– MySQLï¼‰
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         'NAME': 'bookapi_db',
#         'USER': 'bookapi_user',
#         'PASSWORD': 'your-strong-password',
#         'HOST': 'localhost',
#         'PORT': '5432',
#     }
# }
# 4. é™æ€æ–‡ä»¶é…ç½®ï¼ˆç”¨äº Nginx æä¾›é™æ€èµ„æºï¼‰
# STATIC_URL = '/static/'
# STATIC_ROOT = BASE_DIR / 'staticfiles' # å­˜æ”¾æ”¶é›†åçš„é™æ€æ–‡ä»¶
# 5. åª’ä½“æ–‡ä»¶é…ç½®ï¼ˆä¸Šä¼ çš„å›¾ç‰‡ç­‰ï¼‰
# MEDIA_URL = '/media/'
# MEDIA_ROOT = BASE_DIR / 'media' # å­˜æ”¾ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
# 6. CSRF å®‰å…¨è®¾ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯ï¼‰
# CSRF_COOKIE_SECURE = True # httpsç¯å¢ƒä¸‹å¯ç”¨
# CSRF_COOKIE_HTTPONLY = True # é˜²æ­¢XSSæ”»å‡»
# CSRF_TRUSTED_ORIGINS = ['https://your-domain.com'] # åªå…è®¸ç‰¹å®šåŸŸåå‘èµ·è¯·æ±‚
# 7. Session å®‰å…¨è®¾ç½®
# SESSION_COOKIE_SECURE = True
# SESSION_COOKIE_HTTPONLY = True
# SESSION_COOKIE_SAMESITE = 'Lax'
# 8. å¯†é’¥è®¾ç½®ï¼ˆä¸è¦ç¡¬ç¼–ç ï¼ å»ºè®®ç”¨ç¯å¢ƒå˜é‡ï¼‰
# SECRET_KEY = 'your-very-secret-key-here' # ç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®å¼ºå¯†é’¥
# 9. CORS è®¾ç½®ï¼ˆå¦‚æœéœ€è¦è·¨åŸŸï¼‰
# INSTALLED_APPS = [
#     # å…¶ä»–åº”ç”¨ã€‚ã€‚ã€‚
#     'corsheaders', # å¦‚æœä½ å®‰è£…äº†corsheaders
# ]
# MIDDLEWARE = [
#     #ã€‚ã€‚ã€‚å…¶ä»–ä¸­é—´ä»¶
#     'corsheaders.middleware.CorsMiddleware',  # å¿…é¡»æ”¾åœ¨æœ€å‰é¢
#
# ]

# 10. corsé…ç½®
# CORS_ALLOWED_ORIGINS = [
#     'https://frontend.your-domain.com',  # å‰ç«¯åŸŸå
#     'http://localhost:3000',             # å¼€å‘æ—¶æœ¬åœ°æµ‹è¯•
# ]
# CORS_ALLOW_ALL_ORIGINS = False  # ä¸å…è®¸æ‰€æœ‰æ¥æºï¼ˆå®‰å…¨å»ºè®®ï¼‰
